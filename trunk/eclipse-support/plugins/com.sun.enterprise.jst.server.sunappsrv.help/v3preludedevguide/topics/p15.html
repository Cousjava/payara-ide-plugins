<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en-US">
<head>
<meta http-equiv="Content-type" content="text/html; charset=utf-8">
<title>Using the JDBC API for Database Access - Sun GlassFish Enterprise Server v3 Prelude Developer's Guide</title>
<meta name="robots" content="index,follow">
<meta name="robots" content="index,follow">
<meta name="date" content="2008-10-01">
</head>

<body>


<table border="0" cellpadding="5" cellspacing="0" width="100%">
<tr><td colspan="5"></td></tr>
<tr>
<td></td>
<td style="width: 60%">&#160;</td>
<td><a href="p14.html">Previous</a></td>
<td></td>
<td><a href="idx-1.html">Index</a></td>
<td><a href="p16.html">Next</a></td>
</tr>
</table>


<a name="beamj"></a>Chapter&#160;9<h3>Using the JDBC API for Database Access</h3><a name="indexterm-335"></a><p>This chapter describes how to use the Java<sup>TM</sup> Database Connectivity (JDBC<sup>TM</sup>) API for
database access with the Sun GlassFish Enterprise Server. This chapter also provides high level
JDBC implementation instructions for servlets and EJB components using the Enterprise Server. If
the JDK version 1.6 is used, the Enterprise Server supports the JDBC 4.0
API.</p><p><a name="indexterm-336"></a><a name="indexterm-337"></a>The JDBC specifications are available at <a href="http://java.sun.com/products/jdbc/download.html">http://java.sun.com/products/jdbc/download.html</a>.</p><p><a name="indexterm-338"></a>A useful JDBC tutorial is located at <a href="http://java.sun.com/docs/books/tutorial/jdbc/index.html">http://java.sun.com/docs/books/tutorial/jdbc/index.html</a>.</p>
<hr><p><b>Note - </b>The Enterprise Server does not support connection pooling or transactions for an application&#8217;s
database access if it does not use standard Java EE <tt>DataSource</tt> objects.</p>
<hr>
<p>This chapter discusses the following topics:</p>
<ul><li><p><a href="#beamk">General Steps for Creating a JDBC Resource</a></p></li>
<li><p><a href="#beamr">Creating Web Applications That Use the JDBC API</a></p></li>
<li><p><a href="#geqvg">Restrictions and Optimizations</a></p></li></ul>


<a name="beamk"></a><h3>General Steps for Creating a JDBC Resource</h3>
<p>To prepare a JDBC resource for use in Java EE applications deployed to
the Enterprise Server, perform the following tasks:</p>
<ul><li><p><a href="#beaml">Integrating the JDBC Driver</a></p></li>
<li><p><a href="#beamo">Creating a Connection Pool</a></p></li>
<li><p><a href="#beamp">Testing a JDBC Connection Pool</a></p></li>
<li><p><a href="#beamq">Creating a JDBC Resource</a></p></li></ul>
<p>For information about how to configure some specific JDBC drivers, see <a href="http://docs.sun.com/doc/820-4495/beamw?a=view">Configuration Specifics for JDBC Drivers in <i>Sun GlassFish Enterprise Server v3 Prelude Administration Guide</i></a>.</p>

<a name="beaml"></a><h4>Integrating the JDBC Driver</h4>
<p>To use JDBC features, you must choose a JDBC driver to work with
the Enterprise Server, then you must set up the driver. This section covers
these topics:</p>
<ul><li><p><a href="#beamm">Supported Database Drivers</a></p></li>
<li><p><a href="#beamn">Making the JDBC Driver JAR Files Accessible</a></p></li></ul>


<a name="beamm"></a><h5>Supported Database Drivers</h5>
<a name="indexterm-339"></a><a name="indexterm-340"></a><p>Supported JDBC drivers are those that have been fully tested by Sun. For
a list of the JDBC drivers currently supported by the Enterprise Server, see
the <i><a href="http://docs.sun.com/doc/820-4494"><i>Sun GlassFish Enterprise Server v3 Prelude Release Notes</i></a></i>. For configurations of supported and other drivers, see <a href="http://docs.sun.com/doc/820-4495/beamw?a=view">Configuration Specifics for JDBC Drivers in <i>Sun GlassFish Enterprise Server v3 Prelude Administration Guide</i></a>.</p>
<hr><p><b>Note - </b>Because the drivers and databases supported by the Enterprise Server are constantly being
updated, and because database vendors continue to upgrade their products, always check with
Sun technical support for the latest database support information.</p>
<hr>


<a name="beamn"></a><h5>Making the JDBC Driver JAR Files Accessible</h5>
<a name="indexterm-341"></a><p>To integrate the JDBC driver into an Enterprise Server domain, copy the JAR
files into the <i>domain-dir</i><tt>/lib</tt> directory, then restart the server. This makes classes accessible
to all applications or modules deployed on servers that share the same configuration. For
more information about Enterprise Server class loaders, see <a href="p6.html">Chapter&#160;2, Class Loaders</a>.</p>

<a name="beamo"></a><h4>Creating a Connection Pool</h4>
<a name="indexterm-342"></a><p>When you create a connection pool that uses JDBC technology (a <b>JDBC connection pool</b>) in
the Enterprise Server, you can define many of the characteristics of your database
connections.</p><p>You can create a JDBC connection pool in one of these ways:</p>
<ul><li><p><a name="indexterm-343"></a>In the Administration Console, open the Resources component and select Connection Pools. For details, click the Help button in the Administration Console.</p></li>
<li><p><a name="indexterm-344"></a><a name="indexterm-345"></a>Use the <tt>asadmin create-jdbc-connection-pool</tt> command. For details, see the <a href="http://docs.sun.com/doc/820-4497"><i>Sun GlassFish Enterprise Server v3 Prelude Reference Manual</i></a>.</p></li></ul>
<p>For a complete description of JDBC connection pool features, see the <a href="http://docs.sun.com/doc/820-4495"><i>Sun GlassFish Enterprise Server v3 Prelude Administration Guide</i></a></p>

<a name="beamp"></a><h4>Testing a JDBC Connection Pool</h4>
<p>You can test a JDBC connection pool for usability in one of these
ways:</p>
<ul><li><p><a name="indexterm-346"></a>In the Administration Console, open the Resources component select Connection Pools, and select the connection pool you want to test. Then select the Ping button in the top right corner of the page. For details, click the Help button in the Administration Console.</p></li>
<li><p><a name="indexterm-347"></a><a name="indexterm-348"></a>Use the <tt>asadmin ping-connection-pool</tt> command. For details, see the <a href="http://docs.sun.com/doc/820-4497"><i>Sun GlassFish Enterprise Server v3 Prelude Reference Manual</i></a>.</p></li></ul>
<p>Both these commands fail and display an error message unless they successfully connect
to the connection pool.</p>

<a name="beamq"></a><h4>Creating a JDBC Resource</h4>
<a name="indexterm-349"></a><p>A JDBC resource, also called a data source, lets you make connections to
a database using <tt>getConnection()</tt>. Create a JDBC resource in one of these ways:</p>
<ul><li><p><a name="indexterm-350"></a>In the Administration Console, open the Resources component and select JDBC Resources. For details, click the Help button in the Administration Console.</p></li>
<li><p><a name="indexterm-351"></a><a name="indexterm-352"></a>Use the <tt>asadmin create-jdbc-resource</tt> command. For details, see the <a href="http://docs.sun.com/doc/820-4497"><i>Sun GlassFish Enterprise Server v3 Prelude Reference Manual</i></a>.</p></li></ul>


<a name="beamr"></a><h3>Creating Web Applications That Use the JDBC API</h3>
<p>A web application that uses the JDBC API is an application that looks
up and connects to one or more databases. This section covers these topics:</p>
<ul><li><p><a href="#ghqrx">Setting a Statement Timeout</a></p></li>
<li><p><a href="#beams">Sharing Connections</a></p></li>
<li><p><a href="#ghqxi">Wrapping Connections</a></p></li>
<li><p><a href="#beamt">Obtaining a Physical Connection From a Wrapped Connection</a></p></li>
<li><p><a href="#ggrum">Using the <tt>Connection.unwrap()</tt> Method</a></p></li>
<li><p><a href="#gezfh">Marking Bad Connections</a></p></li>
<li><p><a href="#beamu">Using Non-Transactional Connections</a></p></li>
<li><p><a href="#beamv">Using JDBC Transaction Isolation Levels</a></p></li>
<li><p><a href="#gavro">Allowing Non-Component Callers</a></p></li></ul>


<a name="ghqrx"></a><h4>Setting a Statement Timeout</h4>
<p>An abnormally long running JDBC query executed by an application may leave it
in a hanging state unless a timeout is explicitly set on the statement.
Setting a statement timeout guarantees that all queries automatically time out if not
completed within the specified period. When statements are created, the <tt>queryTimeout</tt> is set according
to the statement timeout setting. This works only when the underlying JDBC driver
supports <tt>queryTimeout</tt> for <tt>Statement</tt>, <tt>PreparedStatement</tt>, <tt>CallableStatement</tt>, and <tt>ResultSet</tt>.</p><p>You can specify a statement timeout in the following ways:</p>
<ul><li><p><a name="indexterm-353"></a>Enter a Statement Timeout value in the JDBC Connection Pools page in the Administration Console. For more information, click the Help button in the Administration Console.</p></li>
<li><p><a name="indexterm-354"></a><a name="indexterm-355"></a>Specify the <tt>--statementtimeout</tt> option in the <tt>asadmin create-jdbc-connection-pool</tt> command. For more information, see the <a href="http://docs.sun.com/doc/820-4497"><i>Sun GlassFish Enterprise Server v3 Prelude Reference Manual</i></a>.</p></li></ul>


<a name="beams"></a><h4>Sharing Connections</h4>
<a name="indexterm-356"></a><a name="indexterm-357"></a><p>When multiple connections acquired by an application use the same JDBC resource, the
connection pool provides connection sharing within the same transaction scope. For example, suppose
Bean A starts a transaction and obtains a connection, then calls a method
in Bean B. If Bean B acquires a connection to the same JDBC
resource with the same sign-on information, and if Bean A completes the transaction, the
connection can be shared.</p><p>Connections obtained through a resource are shared only if the resource reference declared
by the Java EE component allows it to be shareable. This is specified
in a component&#8217;s deployment descriptor by setting the <tt>res-sharing-scope</tt> element to <tt>Shareable</tt> for the
particular resource reference. To turn off connection sharing, set <tt>res-sharing-scope</tt> to <tt>Unshareable</tt>.</p><p>For general information about connections and JDBC URLs, see <a href="http://docs.sun.com/doc/820-4495/ablih?a=view">Chapter 5, Administering Database Connectivity , in <i>Sun GlassFish Enterprise Server v3 Prelude Administration Guide</i></a>.</p>

<a name="ghqxi"></a><h4>Wrapping Connections</h4>
<p>If the Wrap JDBC Objects option is <tt>true</tt>, wrapped JDBC objects are returned
for <tt>Statement</tt>, <tt>PreparedStatement</tt>, <tt>CallableStatement</tt>, <tt>ResultSet</tt>, and <tt>DatabaseMetaData</tt>. The default is false.</p><p>This option ensures that <tt>Statement.getConnection()</tt> is the same as <tt>DataSource.getConnection()</tt>. Therefore, this option should
be <tt>true</tt> when both <tt>Statement.getConnection()</tt> and <tt>DataSource.getConnection()</tt> are done. The default is <tt>false</tt>
to avoid breaking existing applications.</p><p>You can specify the Wrap JDBC Objects option in the following ways:</p>
<ul><li><p><a name="indexterm-358"></a>Check or uncheck the Wrap JDBC Objects box on the JDBC Connection Pools page in the Administration Console. For more information, click the Help button in the Administration Console.</p></li>
<li><p><a name="indexterm-359"></a><a name="indexterm-360"></a>Specify the <tt>--wrapjdbcobjects</tt> option in the <tt>asadmin create-jdbc-connection-pool</tt> command. For more information, see the <a href="http://docs.sun.com/doc/820-4497"><i>Sun GlassFish Enterprise Server v3 Prelude Reference Manual</i></a>.</p></li></ul>


<a name="beamt"></a><h4>Obtaining a Physical Connection From a Wrapped Connection</h4>
<a name="indexterm-361"></a><a name="indexterm-362"></a><p>The <tt>DataSource</tt> implementation in the Enterprise Server provides a <tt>getConnection</tt> method that retrieves
the JDBC driver&#8217;s <tt>SQLConnection</tt> from the Enterprise Server&#8217;s <tt>Connection</tt> wrapper. The method signature is
as follows:</p><pre>public java.sql.Connection getConnection(java.sql.Connection con) 
throws java.sql.SQLException</pre><p>For example:</p><pre>InitialContext ctx = new InitialContext();
com.sun.appserv.jdbc.DataSource ds = (com.sun.appserv.jdbc.DataSource) 
   ctx.lookup("jdbc/MyBase");
Connection con = ds.getConnection();
Connection drivercon = ds.getConnection(con); //get physical connection from wrapper
// Do db operations.
// Do not close driver connection.
con.close(); // return wrapped connection to pool.</pre>

<a name="ggrum"></a><h4>Using the <tt>Connection.unwrap()</tt> Method</h4>
<a name="indexterm-363"></a><a name="indexterm-364"></a><p>If the JDK version 1.6 is used, the Enterprise Server supports JDBC 4.0
 if the JDBC driver is JDBC 4.0 compliant. Using the <tt>Connection.unwrap()</tt>
method on a vendor-provided interface returns an object or a wrapper object implementing
the vendor-provided interface, which the application can make use of to do vendor-specific
database operations.  Use the <tt>Connection.isWrapperFor()</tt> method on a vendor-provided interface to check whether
the connection can provide an implementation of the vendor-provided interface. Check the JDBC driver
vendor's documentation for information on these interfaces.</p>

<a name="gezfh"></a><h4>Marking Bad Connections</h4>
<a name="indexterm-365"></a><p>The <tt>DataSource</tt> implementation in the Enterprise Server provides a <tt>markConnectionAsBad</tt> method. A marked
bad connection is removed from its connection pool when it is closed. The
method signature is as follows:</p><pre>public void markConnectionAsBad(java.sql.Connection con)</pre><p>For example:</p><pre>com.sun.appserv.jdbc.DataSource ds=
   (com.sun.appserv.jdbc.DataSource)context.lookup("dataSource");
Connection con = ds.getConnection();
Statement stmt = null;
try{
   stmt = con.createStatement();
   stmt.executeUpdate("Update");
}
catch (BadConnectionException e){
   ds.markConnectionAsBad(con) //marking it as bad for removal
}
finally{
   stmt.close();    
   con.close(); //Connection will be destroyed during close.
}</pre>

<a name="beamu"></a><h4>Using Non-Transactional Connections</h4>
<a name="indexterm-366"></a><p>You can specify a non-transactional database connection in any of these ways:</p>
<ul><li><p><a name="indexterm-367"></a>Check the Non-Transactional Connections box on the JDBC Connection Pools page in the Administration Console. The default is unchecked. For more information, click the Help button in the Administration Console.</p></li>
<li><p><a name="indexterm-368"></a><a name="indexterm-369"></a>Specify the <tt>--nontransactionalconnections</tt> option in the <tt>asadmin create-jdbc-connection-pool</tt> command. For more information, see the <a href="http://docs.sun.com/doc/820-4497"><i>Sun GlassFish Enterprise Server v3 Prelude Reference Manual</i></a>.</p></li>
<li><p>Use the <tt>DataSource</tt> implementation in the Enterprise Server, which provides a <tt>getNonTxConnection</tt> method. This method retrieves a JDBC connection that is not in the scope of any transaction. There are two variants.</p><pre>public java.sql.Connection getNonTxConnection() throws java.sql.SQLException</pre><pre>public java.sql.Connection getNonTxConnection(String user, String password) 
   throws java.sql.SQLException</pre></li>
<li><p>Create a resource with the JNDI name ending in <tt>__nontx</tt>. This forces all connections looked up using this resource to be non transactional.</p></li></ul>
<p>Typically, a connection is enlisted in the context of the transaction in which
a <tt>getConnection</tt> call is invoked. However, a non-transactional connection is not enlisted in
a transaction context even if a transaction is in progress.</p><p>The main advantage of using non-transactional connections is that the overhead incurred in
enlisting and delisting connections in transaction contexts is avoided. However, use such connections carefully.
For example, if a non-transactional connection is used to query the database while
a transaction is in progress that modifies the database, the query retrieves the
unmodified data in the database. This is because the in-progress transaction hasn&#8217;t committed. For
another example, if a non-transactional connection modifies the database and a transaction that
is running simultaneously rolls back, the changes made by the non-transactional connection are
not rolled back.</p><p><a name="indexterm-370"></a>Here is a typical use case for a non-transactional connection: a component that
is updating a database in a transaction context spanning over several iterations of a
loop can refresh cached data by using a non-transactional connection to read data
before the transaction commits.</p>

<a name="beamv"></a><h4>Using JDBC Transaction Isolation Levels</h4>
<p>For general information about transactions, see <a href="p16.html">Chapter&#160;10, Using the Transaction Service</a>. For information about last agent
optimization, which can improve performance, see <a href="p16.html#beano">Transaction Scope</a>.</p><p><a name="indexterm-371"></a><a name="indexterm-372"></a>Not all database vendors support all transaction isolation levels available in the JDBC API.
The Enterprise Server permits specifying any isolation level your database supports. The following
table defines transaction isolation levels.</p><a name="fvyoi"></a><h6>Table&#160;9-1 Transaction Isolation Levels</h6><table><col width="36%"><col width="63%"><tr><th align="left" valign="top" scope="column"><p>Transaction Isolation Level</p></th>
<th align="left" valign="top" scope="column"><p>Description</p></th>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>TRANSACTION_READ_UNCOMMITTED</tt></p></td>
<td align="left" valign="top" scope="row"><p>Dirty reads, non-repeatable reads, and phantom reads
can occur.</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>TRANSACTION_READ_COMMITTED</tt></p></td>
<td align="left" valign="top" scope="row"><p>Dirty reads are prevented; non-repeatable reads and phantom reads can occur.</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>TRANSACTION_REPEATABLE_READ</tt></p></td>
<td align="left" valign="top" scope="row"><p>Dirty reads
and non-repeatable reads are prevented; phantom reads can occur.</p></td>
</tr>
<tr><td align="left" valign="top" scope="row"><p><tt>TRANSACTION_SERIALIZABLE</tt></p></td>
<td align="left" valign="top" scope="row"><p>Dirty reads, non-repeatable reads and
phantom reads are prevented.</p></td>
</tr>
</table><p>You can specify the transaction isolation level in the following ways:</p>
<ul><li><p><a name="indexterm-373"></a>Select the value from the Transaction Isolation drop-down list on the JDBC Connection Pools page in the Administration Console. For more information, click the Help button in the Administration Console.</p></li>
<li><p><a name="indexterm-374"></a><a name="indexterm-375"></a>Specify the <tt>--isolationlevel</tt> option in the <tt>asadmin create-jdbc-connection-pool</tt> command. For more information, see the <a href="http://docs.sun.com/doc/820-4497"><i>Sun GlassFish Enterprise Server v3 Prelude Reference Manual</i></a>.</p></li></ul>
<p><a name="indexterm-376"></a>Note that you cannot call <tt>setTransactionIsolation()</tt> during a transaction.</p><p>You can set the default transaction isolation level for a JDBC connection pool.
For details, see <a href="#beamo">Creating a Connection Pool</a>.</p><p><a name="indexterm-377"></a>To verify that a level is supported by your database management system, test
your database programmatically using the <tt>supportsTransactionIsolationLevel()</tt> method in <tt>java.sql.DatabaseMetaData</tt>, as shown in the
following example:</p><pre>InitialContext ctx = new InitialContext();
DataSource ds = (DataSource)
ctx.lookup("jdbc/MyBase");
Connection con = ds.getConnection();
DatabaseMetaData dbmd = con.getMetaData();
if (dbmd.supportsTransactionIsolationLevel(TRANSACTION_SERIALIZABLE)
{ Connection.setTransactionIsolation(TRANSACTION_SERIALIZABLE); }</pre><p>For more information about these isolation levels and what they mean, see the
JDBC API specification.</p>
<hr><p><b>Note - </b>Applications that change the isolation level on a pooled connection programmatically risk polluting
the pool, which can lead to errors.</p>
<hr>


<a name="gavro"></a><h4>Allowing Non-Component Callers</h4>
<a name="indexterm-378"></a><p>You can allow non-Java-EE components, such as servlet filters and third party persistence
managers, to use this JDBC connection pool. The returned connection is automatically enlisted
with the transaction context obtained from the transaction manager. Standard Java EE components can
also use such pools. Connections obtained by non-component callers are not automatically closed
at the end of a transaction by the container. They must be explicitly
closed by the caller.</p><p>You can enable non-component callers in the following ways:</p>
<ul><li><p><a name="indexterm-379"></a>Check the Allow Non Component Callers box on the JDBC Connection Pools page in the Administration Console. The default is <tt>false</tt>. For more information, click the Help button in the Administration Console.</p></li>
<li><p><a name="indexterm-380"></a><a name="indexterm-381"></a>Specify the <tt>--allownoncomponentcallers</tt> option in the <tt>asadmin create-jdbc-connection-pool</tt> command. For more information, see the <a href="http://docs.sun.com/doc/820-4497"><i>Sun GlassFish Enterprise Server v3 Prelude Reference Manual</i></a>.</p></li>
<li><p>Create a JDBC resource with a <tt>__pm</tt> suffix.</p></li></ul>


<a name="geqvg"></a><h3>Restrictions and Optimizations</h3>
<a name="indexterm-382"></a><p>This section discusses restrictions and performance optimizations that affect using the JDBC API.</p>

<a name="geqvy"></a><h4>Disabling Stored Procedure Creation on Sybase</h4>
<p>By default, DataDirect and Sun GlassFish JDBC drivers for Sybase databases create a
stored procedure for each parameterized <tt>PreparedStatement</tt>. On the Enterprise Server, exceptions are
thrown when primary key identity generation is attempted. To disable the creation of
these stored procedures, set the property <tt>PrepareMethod=direct</tt> for the JDBC connection pool.</p>


<table border="0" cellpadding="5" cellspacing="0" width="100%">
<tr valign="bottom">
<td></td>
<td style="width: 60%"></td>
<td><a href="p14.html">Previous</a></td>
<td></td>
<td><a href="idx-1.html">Index</a></td>
<td><a href="p16.html">Next</a></td>
</tr>
</table>



</body>
</html>

